{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 103, "column": 0}, "map": {"version":3,"sources":["file:///C:/ata/ins_post_creator/post_kidsai%20-%20Kopya/src/app/api/render/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { bundle } from '@remotion/bundler';\r\nimport { renderMedia, selectComposition } from '@remotion/renderer';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\nimport { pipeline } from 'stream/promises';\r\nimport os from 'os';\r\nimport { pathToFileURL } from 'url';\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get('file') as File;\r\n    const inputPropsStr = formData.get('inputProps') as string;\r\n\r\n    if (!file || !inputPropsStr) {\r\n      return NextResponse.json({ error: 'Dosya veya ayarlar eksik' }, { status: 400 });\r\n    }\r\n\r\n    // 1. Dosyayı geçici klasöre kaydet (Base64 yerine File System kullanıyoruz)\r\n    // Base64 büyük videolarda performans sorunu yaratır ve videonun oynamasını engeller.\r\n    const buffer = Buffer.from(await file.arrayBuffer());\r\n    const tempDir = os.tmpdir();\r\n    const tempFileName = `video-${Date.now()}.mp4`; // Basit isim kullanarak karakter sorunlarını önle\r\n    const tempFilePath = path.join(tempDir, tempFileName);\r\n    await fs.promises.writeFile(tempFilePath, buffer);\r\n\r\n    // 2. Input Props'u güncelle (Video kaynağı olarak File URL kullan)\r\n    const inputProps = JSON.parse(inputPropsStr);\r\n    inputProps.videoSrc = pathToFileURL(tempFilePath).href;\r\n\r\n    // --- YENİ: Statik görselleri Base64'e çevirip prop olarak ekle ---\r\n    // Bu işlem, render sırasında \"Error loading image\" hatasını önler.\r\n    const publicDir = path.join(process.cwd(), 'public');\r\n    const readImageAsDataUri = async (filename: string) => {\r\n        try {\r\n            const filePath = path.join(publicDir, filename);\r\n            const fileBuffer = await fs.promises.readFile(filePath);\r\n            const ext = path.extname(filename).replace('.', '');\r\n            return `data:image/${ext === 'svg' ? 'svg+xml' : ext};base64,${fileBuffer.toString('base64')}`;\r\n        } catch (e) {\r\n            console.warn(`Görsel okunamadı: ${filename}`, e);\r\n            return null; // Dosya yoksa null döner, bileşen fallback kullanır\r\n        }\r\n    };\r\n\r\n    inputProps.images = {\r\n        appStore: await readImageAsDataUri('appstore.png'),\r\n        google: await readImageAsDataUri('google.png'),\r\n        icon: await readImageAsDataUri('icon.png'),\r\n    };\r\n    // ---------------------------------------------------------------\r\n\r\n    // 3. Projeyi Bundle Et (Derle)\r\n    // Not: src/remotion/index.ts dosyasının var olduğu varsayılır\r\n    const entryPoint = path.join(process.cwd(), 'src', 'remotion', 'index.ts');\r\n    const bundleLocation = await bundle({\r\n      entryPoint,\r\n      // Webpack alias (@/...) desteği için yapılandırma\r\n      webpackOverride: (config) => {\r\n        // Mevcut CSS kurallarını temizle (Çakışmayı önlemek için)\r\n        const rules = (config.module?.rules || []).filter((rule) => {\r\n            if (rule && typeof rule === 'object' && 'test' in rule && String(rule.test).includes('css')) {\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n\r\n        return {\r\n          ...config,\r\n          module: {\r\n            ...config.module,\r\n            rules: [\r\n                ...rules,\r\n                {\r\n                    test: /\\.css$/i,\r\n                    use: [\r\n                        \"style-loader\",\r\n                        \"css-loader\",\r\n                        // Tailwind'in çalışması için PostCSS Loader ekliyoruz\r\n                        {\r\n                            loader: \"postcss-loader\",\r\n                            options: {\r\n                                postcssOptions: {\r\n                                    plugins: [\r\n                                        require(\"tailwindcss\"),\r\n                                        require(\"autoprefixer\"),\r\n                                    ],\r\n                                },\r\n                            },\r\n                        }\r\n                    ],\r\n                },\r\n            ],\r\n          },\r\n          resolve: {\r\n            ...config.resolve,\r\n            alias: {\r\n              ...(config.resolve?.alias || {}),\r\n              '@': path.join(process.cwd(), 'src'),\r\n            },\r\n          },\r\n        };\r\n      },\r\n    });\r\n\r\n    // 4. Kompozisyonu Seç\r\n    const composition = await selectComposition({\r\n      serveUrl: bundleLocation,\r\n      id: 'KidsAIReel', // Remotion Root içindeki ID ile aynı olmalı\r\n      inputProps,\r\n    });\r\n\r\n    // 5. Render İşlemi (MP4 Oluştur)\r\n    const outputLocation = path.join(tempDir, `render-${Date.now()}.mp4`);\r\n    \r\n    await renderMedia({\r\n      composition,\r\n      serveUrl: bundleLocation,\r\n      codec: 'h264',\r\n      outputLocation,\r\n      inputProps,\r\n      chromiumOptions: {\r\n        disableWebSecurity: true,\r\n        ignoreCertificateErrors: true,\r\n        gl: 'swangle', // GPU hatalarını önlemek için yazılımsal render\r\n      },\r\n      crf: 12, // Çok Yüksek Kalite (Varsayılan ~23. Değer düştükçe kalite artar. 12 neredeyse kayıpsızdır.)\r\n      imageFormat: 'png', // Metinlerin netliği için PNG şart\r\n      pixelFormat: 'yuv420p', // Geniş uyumluluk ve doğru renkler için\r\n    });\r\n\r\n    // 6. Dosyayı İstemciye Gönder\r\n    const videoBuffer = await fs.promises.readFile(outputLocation);\r\n    \r\n    // Temizlik\r\n    try { \r\n        await fs.promises.unlink(outputLocation); \r\n        await fs.promises.unlink(tempFilePath); // Yüklenen videoyu da sil\r\n    } catch (e) {}\r\n\r\n    return new NextResponse(videoBuffer, {\r\n      headers: {\r\n        'Content-Type': 'video/mp4',\r\n        'Content-Disposition': 'attachment; filename=\"render.mp4\"',\r\n      },\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Render Hatası:', error);\r\n    return NextResponse.json(\r\n      { error: 'Render işlemi başarısız oldu', details: String(error) }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}