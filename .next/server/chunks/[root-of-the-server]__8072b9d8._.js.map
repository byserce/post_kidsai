{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///C:/ata/ins_post_creator/post_kidsai%20-%20Kopya/src/app/api/render/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { bundle } from '@remotion/bundler';\r\nimport { renderMedia, selectComposition } from '@remotion/renderer';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\nimport { pipeline } from 'stream/promises';\r\nimport os from 'os';\r\nimport { pathToFileURL } from 'url';\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get('file') as File;\r\n    const inputPropsStr = formData.get('inputProps') as string;\r\n\r\n    if (!file || !inputPropsStr) {\r\n      return NextResponse.json({ error: 'Dosya veya ayarlar eksik' }, { status: 400 });\r\n    }\r\n\r\n    // 1. Dosyayı geçici klasöre kaydet\r\n    const buffer = Buffer.from(await file.arrayBuffer());\r\n    \r\n    // Kullanıcı klasöründeki özel karakterlerden (örn: \"Atakan Serçe\") kaçınmak için proje içinde temp klasörü kullan\r\n    const tempDir = path.join(process.cwd(), 'temp');\r\n    if (!fs.existsSync(tempDir)) {\r\n        await fs.promises.mkdir(tempDir, { recursive: true });\r\n    }\r\n    \r\n    // Dosya ismindeki özel karakterlerden (Türkçe karakter, boşluk vb.) kaynaklı sorunları önlemek için basit isim kullan\r\n    const ext = path.extname(file.name) || '.mp4';\r\n    const tempFilePath = path.join(tempDir, `upload-${Date.now()}${ext}`);\r\n    await fs.promises.writeFile(tempFilePath, buffer);\r\n\r\n    // 2. Input Props'u güncelle (Video yolunu sunucudaki dosya yolu yap)\r\n    const inputProps = JSON.parse(inputPropsStr);\r\n    inputProps.videoSrc = pathToFileURL(tempFilePath).href; // Windows için file:// formatına çevir\r\n\r\n    // 3. Projeyi Bundle Et (Derle)\r\n    // Not: src/remotion/index.ts dosyasının var olduğu varsayılır\r\n    const entryPoint = path.join(process.cwd(), 'src', 'remotion', 'index.ts');\r\n    const bundleLocation = await bundle({\r\n      entryPoint,\r\n      // Webpack alias (@/...) desteği için yapılandırma\r\n      webpackOverride: (config) => {\r\n        return {\r\n          ...config,\r\n          resolve: {\r\n            ...config.resolve,\r\n            alias: {\r\n              ...(config.resolve?.alias || {}),\r\n              '@': path.join(process.cwd(), 'src'),\r\n            },\r\n          },\r\n        };\r\n      },\r\n    });\r\n\r\n    // 4. Kompozisyonu Seç\r\n    const composition = await selectComposition({\r\n      serveUrl: bundleLocation,\r\n      id: 'KidsAIReel', // Remotion Root içindeki ID ile aynı olmalı\r\n      inputProps,\r\n    });\r\n\r\n    // 5. Render İşlemi (MP4 Oluştur)\r\n    const outputLocation = path.join(tempDir, `render-${Date.now()}.mp4`);\r\n    await renderMedia({\r\n      composition,\r\n      serveUrl: bundleLocation,\r\n      codec: 'h264',\r\n      outputLocation,\r\n      inputProps,\r\n      chromiumOptions: {\r\n        disableWebSecurity: true,\r\n        ignoreCertificateErrors: true,\r\n        gl: 'swangle', // GPU hatalarını önlemek için yazılımsal render\r\n      },\r\n    });\r\n\r\n    // 6. Dosyayı İstemciye Gönder\r\n    const videoBuffer = await fs.promises.readFile(outputLocation);\r\n    \r\n    // Temizlik (İsteğe bağlı, hemen silmek bazen stream hatası verebilir)\r\n    // await fs.promises.unlink(tempFilePath);\r\n    // await fs.promises.unlink(outputLocation);\r\n\r\n    return new NextResponse(videoBuffer, {\r\n      headers: {\r\n        'Content-Type': 'video/mp4',\r\n        'Content-Disposition': 'attachment; filename=\"render.mp4\"',\r\n      },\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Render Hatası:', error);\r\n    return NextResponse.json(\r\n      { error: 'Render işlemi başarısız oldu', details: String(error) }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AAGA;;;;;;;;;;;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,MAAM,gBAAgB,SAAS,GAAG,CAAC;QAEnC,IAAI,CAAC,QAAQ,CAAC,eAAe;YAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,mCAAmC;QACnC,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;QAEjD,kHAAkH;QAClH,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;QACzC,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,UAAU;YACzB,MAAM,wGAAE,CAAC,QAAQ,CAAC,KAAK,CAAC,SAAS;gBAAE,WAAW;YAAK;QACvD;QAEA,sHAAsH;QACtH,MAAM,MAAM,4GAAI,CAAC,OAAO,CAAC,KAAK,IAAI,KAAK;QACvC,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,KAAK,GAAG,KAAK,KAAK;QACpE,MAAM,wGAAE,CAAC,QAAQ,CAAC,SAAS,CAAC,cAAc;QAE1C,qEAAqE;QACrE,MAAM,aAAa,KAAK,KAAK,CAAC;QAC9B,WAAW,QAAQ,GAAG,IAAA,gHAAa,EAAC,cAAc,IAAI,EAAE,uCAAuC;QAE/F,+BAA+B;QAC/B,8DAA8D;QAC9D,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,OAAO,YAAY;QAC/D,MAAM,iBAAiB,MAAM,IAAA,6IAAM,EAAC;YAClC;YACA,kDAAkD;YAClD,iBAAiB,CAAC;gBAChB,OAAO;oBACL,GAAG,MAAM;oBACT,SAAS;wBACP,GAAG,OAAO,OAAO;wBACjB,OAAO;4BACL,GAAI,OAAO,OAAO,EAAE,SAAS,CAAC,CAAC;4BAC/B,KAAK,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;wBAChC;oBACF;gBACF;YACF;QACF;QAEA,sBAAsB;QACtB,MAAM,cAAc,MAAM,IAAA,iKAAiB,EAAC;YAC1C,UAAU;YACV,IAAI;YACJ;QACF;QAEA,iCAAiC;QACjC,MAAM,iBAAiB,4GAAI,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,KAAK,GAAG,GAAG,IAAI,CAAC;QACpE,MAAM,IAAA,2JAAW,EAAC;YAChB;YACA,UAAU;YACV,OAAO;YACP;YACA;YACA,iBAAiB;gBACf,oBAAoB;gBACpB,yBAAyB;gBACzB,IAAI;YACN;QACF;QAEA,8BAA8B;QAC9B,MAAM,cAAc,MAAM,wGAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAE/C,sEAAsE;QACtE,0CAA0C;QAC1C,4CAA4C;QAE5C,OAAO,IAAI,gJAAY,CAAC,aAAa;YACnC,SAAS;gBACP,gBAAgB;gBAChB,uBAAuB;YACzB;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAgC,SAAS,OAAO;QAAO,GAChE;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}