{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///C:/ata/ins_post_creator/post_kidsai%20-%20Kopya/src/app/api/render/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { bundle } from '@remotion/bundler';\r\nimport { renderMedia, selectComposition } from '@remotion/renderer';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\nimport os from 'os';\r\nimport { pathToFileURL } from 'url';\r\nimport ffmpeg from 'fluent-ffmpeg';\r\nimport ffmpegInstaller from 'ffmpeg-static';\r\n\r\n// FFmpeg Binary yolunu ayarla\r\nif (ffmpegInstaller) {\r\n    ffmpeg.setFfmpegPath(ffmpegInstaller);\r\n}\r\n\r\n// Videoyu H.264 formatına dönüştüren yardımcı fonksiyon\r\nconst convertToCompatibleFormat = (inputPath: string, outputPath: string): Promise<void> => {\r\n    return new Promise((resolve, reject) => {\r\n        ffmpeg(inputPath)\r\n            .outputOptions([\r\n                '-c:v libx264',      // Video Codec: H.264 (En uyumlu format)\r\n                '-preset ultrafast', // Hızlı dönüştürme için\r\n                '-crf 23',           // Kalite ayarı (Düşük değer = Yüksek kalite)\r\n                '-c:a aac',          // Ses Codec: AAC\r\n                '-b:a 128k',         // Ses Bitrate\r\n                '-movflags +faststart', // Web için optimize et\r\n                '-pix_fmt yuv420p'   // Renk formatını standartlaştır\r\n            ])\r\n            .save(outputPath)\r\n            .on('end', () => resolve())\r\n            .on('error', (err) => reject(err));\r\n    });\r\n};\r\n\r\nexport async function POST(req: NextRequest) {\r\n  // Temizlik için dosya yollarını tutacağımız liste\r\n  const filesToClean: string[] = [];\r\n\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get('file') as File;\r\n    const inputPropsStr = formData.get('inputProps') as string;\r\n\r\n    if (!file || !inputPropsStr) {\r\n      return NextResponse.json({ error: 'Dosya veya ayarlar eksik' }, { status: 400 });\r\n    }\r\n\r\n    // 1. Dosyayı geçici klasöre kaydet\r\n    const buffer = Buffer.from(await file.arrayBuffer());\r\n    \r\n    // Proje dizini içinde temp klasörü oluştur (İzin sorunlarını önlemek için)\r\n    const tempDir = path.join(process.cwd(), 'temp');\r\n    if (!fs.existsSync(tempDir)) {\r\n        await fs.promises.mkdir(tempDir, { recursive: true });\r\n    }\r\n\r\n    // Orijinal dosya\r\n    const originalExt = path.extname(file.name) || '.mp4';\r\n    const originalFilePath = path.join(tempDir, `raw-${Date.now()}${originalExt}`);\r\n    await fs.promises.writeFile(originalFilePath, buffer);\r\n    filesToClean.push(originalFilePath);\r\n\r\n    // 2. Videoyu Uyumlu Formata (H.264) Dönüştür\r\n    // Bu adım, \"Format Error\" ve \"Video Oynamıyor\" sorunlarını kesin olarak çözer.\r\n    const convertedFilePath = path.join(tempDir, `converted-${Date.now()}.mp4`);\r\n    await convertToCompatibleFormat(originalFilePath, convertedFilePath);\r\n    filesToClean.push(convertedFilePath);\r\n\r\n    // 3. Input Props'u güncelle (Dönüştürülmüş videoyu kullan)\r\n    const inputProps = JSON.parse(inputPropsStr);\r\n    inputProps.videoSrc = pathToFileURL(convertedFilePath).href;\r\n\r\n    // --- Statik görselleri Base64'e çevirip prop olarak ekle ---\r\n    const publicDir = path.join(process.cwd(), 'public');\r\n    const readImageAsDataUri = async (filename: string) => {\r\n        try {\r\n            const filePath = path.join(publicDir, filename);\r\n            const fileBuffer = await fs.promises.readFile(filePath);\r\n            const ext = path.extname(filename).replace('.', '');\r\n            return `data:image/${ext === 'svg' ? 'svg+xml' : ext};base64,${fileBuffer.toString('base64')}`;\r\n        } catch (e) {\r\n            return null;\r\n        }\r\n    };\r\n\r\n    inputProps.images = {\r\n        appStore: await readImageAsDataUri('appstore.png'),\r\n        google: await readImageAsDataUri('google.png'),\r\n        icon: await readImageAsDataUri('icon.png'),\r\n    };\r\n    // ---------------------------------------------------------\r\n\r\n    // 4. Projeyi Bundle Et\r\n    const entryPoint = path.join(process.cwd(), 'src', 'remotion', 'index.ts');\r\n    const bundleLocation = await bundle({\r\n      entryPoint,\r\n      webpackOverride: (config) => {\r\n        const rules = (config.module?.rules || []).filter((rule) => {\r\n            if (rule && typeof rule === 'object' && 'test' in rule && String(rule.test).includes('css')) {\r\n                return false;\r\n            }\r\n            return true;\r\n        });\r\n\r\n        return {\r\n          ...config,\r\n          module: {\r\n            ...config.module,\r\n            rules: [\r\n                ...rules,\r\n                {\r\n                    test: /\\.css$/i,\r\n                    use: [\r\n                        \"style-loader\",\r\n                        \"css-loader\",\r\n                        {\r\n                            loader: \"postcss-loader\",\r\n                            options: {\r\n                                postcssOptions: {\r\n                                    plugins: [\r\n                                        require(\"tailwindcss\"),\r\n                                        require(\"autoprefixer\"),\r\n                                    ],\r\n                                },\r\n                            },\r\n                        }\r\n                    ],\r\n                },\r\n            ],\r\n          },\r\n          resolve: {\r\n            ...config.resolve,\r\n            alias: {\r\n              ...(config.resolve?.alias || {}),\r\n              '@': path.join(process.cwd(), 'src'),\r\n            },\r\n          },\r\n        };\r\n      },\r\n    });\r\n\r\n    // 5. Render İşlemi (MP4 Oluştur)\r\n    const outputLocation = path.join(tempDir, `render-${Date.now()}.mp4`);\r\n    filesToClean.push(outputLocation);\r\n    \r\n    await renderMedia({\r\n      composition,\r\n      serveUrl: bundleLocation,\r\n      codec: 'h264',\r\n      outputLocation,\r\n      inputProps,\r\n      chromiumOptions: {\r\n        disableWebSecurity: true,\r\n        ignoreCertificateErrors: true,\r\n        gl: 'swangle',\r\n      },\r\n      crf: 18, // Kalite ayarı (18-23 arası idealdir)\r\n      imageFormat: 'png',\r\n      pixelFormat: 'yuv420p',\r\n    });\r\n\r\n    // 6. Dosyayı İstemciye Gönder\r\n    const videoBuffer = await fs.promises.readFile(outputLocation);\r\n    \r\n    // Temizlik (Dosyaları sil)\r\n    for (const file of filesToClean) {\r\n        try { await fs.promises.unlink(file); } catch (e) {}\r\n    }\r\n\r\n    return new NextResponse(videoBuffer, {\r\n      headers: {\r\n        'Content-Type': 'video/mp4',\r\n        'Content-Disposition': 'attachment; filename=\"render.mp4\"',\r\n      },\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Render Hatası:', error);\r\n    \r\n    // Hata durumunda da temizlik yapmaya çalış\r\n    for (const file of filesToClean) {\r\n        try { await fs.promises.unlink(file); } catch (e) {}\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { error: 'Render işlemi başarısız oldu', details: String(error) }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}